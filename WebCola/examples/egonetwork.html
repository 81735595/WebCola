<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Egocentric Network</title>
    <style>
        
@import url(../style.css);
.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .8;
}

</style>
</head>
<body>
    <h1>Egocentric Network</h1>
<script src="../extern/d3.v3.js"></script>
    <script src="../cola.v2.min.js"></script>
    <script src="../src/d3adaptor.js"></script>
    <script src="../src/linklengths.js"></script>
<script>
    var width = 300,
        height = 350;

    var color = d3.scale.category20();

    d3.select("body").append("button").attr("id", "removeSelfButton").text("Disconnect Self").on("click", disconnectNode0);

    var d3cola = cola.d3adaptor().convergenceThreshold(1e-4)
        .size([width, height]);

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);

    
    var edges = [];
    var n = 0;

    d3.text("alex/matrix_ego.txt",
        function (error, text) {
            var lines = text.split('\n').map(function (s) { return s.trim() });
            lines.forEach(function (l, i) {
                if (l.length > 0) {
                    l.split(' ').forEach(function (d, j) {
                        if (Number(d) > 0) {
                            edges.push({source: i, target: j});
                        }
                    });
                }
                ++n;
            });
            loaded();
        });

    var link, node;

    function disconnectNode0() {
        edges = edges.filter(function (e) {
            return e.source.index !== 0 && e.target.index !== 0;
        });
        d3cola.stop();
        d3cola.on("tick", null);
        d3cola.links(edges).start(30);
        link.data(d3cola.links(), function (d) {
            return d.source.index + "-" + d.target.index;
        }).exit().remove();
        d3cola.on("tick", function () {
            link.transition().duration(1000).attr("x1", function (d) { return d.source.x; })
                .attr("y1", function (d) { return d.source.y; })
                .attr("x2", function (d) { return d.target.x; })
                .attr("y2", function (d) { return d.target.y; });

            node.transition().duration(1000).attr("cx", function (d) { return d.x; })
                .attr("cy", function (d) { return d.y; }).each("end", function () {
                    d3cola.on("tick", regularTick);
                });
        });
    }

    function regularTick () {
        link.attr("x1", function (d) { return d.source.x; })
            .attr("y1", function (d) { return d.source.y; })
            .attr("x2", function (d) { return d.target.x; })
            .attr("y2", function (d) { return d.target.y; });

        node.attr("cx", function (d) { return d.x; })
            .attr("cy", function (d) { return d.y; });
    };

    function loaded() {
        d3cola
            .links(edges)
            .linkDistance(d3cola.symmetricDiffLinkLengths(8))
            .start(30);

        var nodes = d3cola.nodes();
        nodes.forEach(function (v) { v.width = 20; v.height = 20; });

        link = svg.selectAll(".link")
            .data(d3cola.links(), function (d) {
                return d.source.index + "-" + d.target.index;
            });

        link.enter().append("line")
            .attr("class", "link")
            .style("stroke-width", function (d) { return Math.sqrt(d.value); });


        node = svg.selectAll(".node")
            .data(nodes)
          .enter().append("circle")
            .attr("class", "node")
            .attr("r", function (d, i) { return i === 0 ? 7 : 5 })
            .style("fill", function (d, i) { return i === 0 ? "red" : "#8e8ec7" })
            .call(d3cola.drag);

        node.append("title")
            .text(function (d) { return d.index; });

        d3cola.on("tick", regularTick);
    };

</script>
<p>This is the friend network of a particular person (the red node).  Since by definition there is a link from the red node to all the blue nodes (their friends),
    there's really no point showing all those links.  Therefore, pressing the button removes those links and rearranges the network to tidy it up.
</body>
</html>
