<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Egocentric Network</title>
    <style>
        
@import url(../style.css);
.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .8;
}

</style>
</head>
<body>
    <h1>Egocentric Network</h1>
<script src="../extern/d3.v3.js"></script>
    <script src="../cola.v2.min.js"></script>
    <script src="../src/d3adaptor.js"></script>
    <script src="../src/linklengths.js"></script>
<script>
    var width = 280,
        height = 280;

    var color = d3.scale.category20();

    function disconnectNode0() {
        egosvg1.disconnectNode0();
        egosvg2.disconnectNode0();
        egosvg1.restart();
        egosvg2.restart();
    }

    var body = d3.select("body");
    body.append("center").append("button").attr("id", "removeSelfButton").text("Disconnect Self").on("click", disconnectNode0);
    body.append("br");

    var egosvg = (function () {
        function egosvg(file) {
            this.d3cola = cola.d3adaptor().convergenceThreshold(1e-4)
                .size([width, height]);

            this.svg = d3.select("body").append("svg")
                .attr("width", width)
                .attr("height", height);

            this.edges = [];

            var _this = this;

            //d3.text("graphdata/alex/alex_network_sym.txt",
            d3.text(file,
                function (error, text) {
                    var lines = text.split('\n').map(function (s) { return s.trim() });
                    lines.forEach(function (l, i) {
                        if (l.length > 0) {
                            l.split(' ').forEach(function (d, j) {
                                if (Number(d) > 0) {
                                    _this.edges.push({ source: i, target: j });
                                }
                            });
                        }
                    });
                    _this.loaded();
                });
        }

        egosvg.prototype.disconnectNode0 = function () {
            this.edges = this.edges.filter(function (e) {
                return e.source.index !== 0 && e.target.index !== 0;
            });
            this.d3cola.stop();
            this.d3cola.on("tick", null);
            this.d3cola.links(this.edges).start(30);
            this.link.data(this.d3cola.links(), function (d) {
                return d.source.index + "-" + d.target.index;
            }).exit().remove();
        };
            
        egosvg.prototype.restart = function () {
            var _this = this;
            _this.link.transition().duration(1000).attr("x1", function (d) { return d.source.x; })
                .attr("y1", function (d) { return d.source.y; })
                .attr("x2", function (d) { return d.target.x; })
                .attr("y2", function (d) { return d.target.y; });

            _this.node.transition().duration(1000).attr("cx", function (d) { return d.x; })
                .attr("cy", function (d) { return d.y; }).each("end", function () {
                    _this.d3cola.on("tick", function () { regularTick(_this.link, _this.node) });
                });
        }

        var regularTick = function (link, node) {
            link.attr("x1", function (d) { return d.source.x; })
                .attr("y1", function (d) { return d.source.y; })
                .attr("x2", function (d) { return d.target.x; })
                .attr("y2", function (d) { return d.target.y; });

            node.attr("cx", function (d) { return d.x; })
                .attr("cy", function (d) { return d.y; });
        };

        egosvg.prototype.loaded = function () {
            var _this = this;
            this.d3cola
                .links(this.edges)
                .linkDistance(this.d3cola.symmetricDiffLinkLengths(8))
                .start(30);

            var nodes = this.d3cola.nodes();
            nodes.forEach(function (v) { v.width = 20; v.height = 20; });

            this.link = this.svg.selectAll(".link")
                .data(this.d3cola.links(), function (d) {
                    return d.source.index + "-" + d.target.index;
                });

            this.link.enter().append("line")
                .attr("class", "link")
                .style("stroke-width", function (d) { return Math.sqrt(d.value); });


            this.node = this.svg.selectAll(".node")
                .data(nodes)
              .enter().append("circle")
                .attr("class", "node")
                .attr("r", function (d, i) { return i === 0 ? 7 : 5 })
                .style("fill", function (d, i) { return i === 0 ? "red" : "#8e8ec7" })
                .call(this.d3cola.drag);

            this.node.append("title")
                .text(function (d) { return d.index; });

            this.d3cola.on("tick", function () { regularTick(_this.link, _this.node) });
        };
        return egosvg;
    })();
    var egosvg1 = new egosvg("graphdata/alex/no_partner_matrix.txt");
    var egosvg2 = new egosvg("graphdata/alex/alex_network_sym.txt");

</script>
<p>This is the friend network of a particular person (the red node).  Since by definition there is a link from the red node to all the blue nodes (their friends),
    there's really no point showing all those links.  Therefore, pressing the button removes those links and rearranges the network to tidy it up.
</body>
</html>
